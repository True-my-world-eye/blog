// å…¬å‘Šæ åŠ¨æ€å†…å®¹è„šæœ¬

// è·å–å½“å‰æ—¶é—´
function getCurrentTime() {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  return `${hours}:${minutes}`;
}

// æ ¹æ®æ—¶é—´è¿”å›ä¸åŒçš„é—®å€™è¯­
function getGreeting() {
  const hours = new Date().getHours();
  if (hours >= 5 && hours < 12) {
    return 'æ—©ä¸Šå¥½';
  } else if (hours >= 12 && hours < 14) {
    return 'ä¸­åˆå¥½';
  } else if (hours >= 14 && hours < 18) {
    return 'ä¸‹åˆå¥½';
  } else if (hours >= 18 && hours < 22) {
    return 'æ™šä¸Šå¥½';
  } else {
    return 'å¤œç”Ÿæ´»å—¨èµ·æ¥';
  }
}

// è·å–ç«™é•¿IPåœ°å€ï¼ˆæœåŠ¡å™¨IPï¼‰
async function getServerIP() {
  try {
    // åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return '192.168.1.1'; // æœ¬åœ°å¼€å‘ç¯å¢ƒä¸‹çš„æ¨¡æ‹Ÿæ•°æ®
    }
    
    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨æœåŠ¡å™¨çš„å®é™…IP
    // è¿™é‡Œå¯ä»¥ç›´æ¥è¿”å›æœåŠ¡å™¨IPï¼Œå› ä¸ºé™æ€ç½‘ç«™éƒ¨ç½²åï¼Œè¿™ä¸ªIPå°±æ˜¯å›ºå®šçš„
    // å¯ä»¥åœ¨éƒ¨ç½²å‰æ‰‹åŠ¨è®¾ç½®ä¸ºæœåŠ¡å™¨çš„å®é™…IP
    return window.location.hostname; // ä½¿ç”¨å½“å‰åŸŸåä½œä¸ºæœåŠ¡å™¨IP
  } catch (error) {
    console.error('è·å–æœåŠ¡å™¨IPå¤±è´¥:', error);
    return window.location.hostname || '127.0.0.1'; // é»˜è®¤ä½¿ç”¨å½“å‰åŸŸå
  }
}

// è·å–è®¿å®¢IPåœ°å€å’Œåœ°ç†ä½ç½®
async function getVisitorInfo() {
  try {
    // æœ¬åœ°å¼€å‘ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return {
        ip: '183.247.9.127',
        province: 'æµ™æ±Ÿçœ',
        city: 'æ­å·å¸‚',
        district: 'é’±å¡˜åŒº',
        latitude: 30.2741,
        longitude: 120.1551
      };
    }
    
    // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å®é™…API
    try {
      // å°è¯•ä½¿ç”¨HTTPS
      const ipResponse = await fetch('https://api.ipify.org/?format=json');
      const ipData = await ipResponse.json();
      const ip = ipData.ip;
      
      // ä½¿ç”¨IP-APIè·å–åœ°ç†ä½ç½®ä¿¡æ¯
      // æ³¨æ„ï¼šå…è´¹ç‰ˆAPIæœ‰è¯·æ±‚é™åˆ¶ï¼Œå¦‚æœæµé‡å¤§å»ºè®®ä½¿ç”¨ä»˜è´¹APIæˆ–è‡ªå»ºæœåŠ¡
      const geoResponse = await fetch(`https://ipapi.co/${ip}/json/`);
      const geoData = await geoResponse.json();
      
      return {
        ip: ip,
        province: geoData.region || 'æœªçŸ¥çœä»½',
        city: geoData.city || 'æœªçŸ¥åŸå¸‚',
        district: geoData.district || '',
        latitude: geoData.latitude || 0,
        longitude: geoData.longitude || 0
      };
    } catch (apiError) {
      console.error('HTTPS APIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ:', apiError);
      // å¦‚æœHTTPSè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨HTTP
      const ipResponse = await fetch('http://api.ipify.org/?format=json');
      const ipData = await ipResponse.json();
      const ip = ipData.ip;
      
      const geoResponse = await fetch(`http://ipapi.co/${ip}/json/`);
      const geoData = await geoResponse.json();
      
      return {
        ip: ip,
        province: geoData.region || 'æœªçŸ¥çœä»½',
        city: geoData.city || 'æœªçŸ¥åŸå¸‚',
        district: geoData.district || '',
        latitude: geoData.latitude || 0,
        longitude: geoData.longitude || 0
      };
    }
  } catch (error) {
    console.error('è·å–è®¿å®¢ä¿¡æ¯å¤±è´¥:', error);
    // è¿”å›é»˜è®¤å€¼
    return {
      ip: 'æœªçŸ¥IP',
      province: 'æœªçŸ¥çœä»½',
      city: 'æœªçŸ¥åŸå¸‚',
      district: '',
      latitude: 0,
      longitude: 0
    };
  }
}

// è®¡ç®—ä¸¤ä¸ªåæ ‡ä¹‹é—´çš„è·ç¦»ï¼ˆå•ä½ï¼šå…¬é‡Œï¼‰
function calculateDistance(lat1, lon1, lat2, lon2) {
  if (!lat1 || !lon1 || !lat2 || !lon2) return 'æœªçŸ¥';
  
  // å°†è§’åº¦è½¬æ¢ä¸ºå¼§åº¦
  const radLat1 = (Math.PI * lat1) / 180;
  const radLat2 = (Math.PI * lat2) / 180;
  const radLon1 = (Math.PI * lon1) / 180;
  const radLon2 = (Math.PI * lon2) / 180;
  
  // åœ°çƒåŠå¾„ï¼ˆå•ä½ï¼šå…¬é‡Œï¼‰
  const earthRadius = 6371;
  
  // Haversineå…¬å¼è®¡ç®—è·ç¦»
  const dLat = radLat2 - radLat1;
  const dLon = radLon2 - radLon1;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(radLat1) * Math.cos(radLat2) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = earthRadius * c;
  
  return Math.round(distance).toString();
}

// æ ¹æ®åœ°åŸŸè¿”å›ç›¸åº”çš„è¯—å¥
function getPoemByRegion(province, city) {
  // åœ°åŸŸè¯—å¥æ˜ å°„è¡¨
  const regionPoems = {
    // åŒ—äº¬
    'åŒ—äº¬': [
      'åŒ—äº¬åŸï¼Œå¤éƒ½åŸï¼Œé•¿åŸå†…å¤–å°½æœæ™–ã€‚',
      'æ•…å®«çš„åŸå¢™ï¼Œå¤©å®‰é—¨çš„å¹¿åœºï¼Œè¯‰è¯´ç€åƒå¹´çš„æ²§æ¡‘ã€‚',
      'ç´«ç¦åŸé‡Œæ˜¥å…‰å¥½ï¼Œé•¿åŸè„šä¸‹æœ›äº¬åã€‚'
    ],
    // ä¸Šæµ·
    'ä¸Šæµ·': [
      'é»„æµ¦æ±Ÿæ°´èµ·æ˜¥æ½®ï¼Œæµ¦ä¸œæµ¦è¥¿ç«é£æµã€‚',
      'ä¸œæ–¹æ˜ç è€¸äº‘éœ„ï¼Œé™†å®¶å˜´ä¸Šå±•æ–°å§¿ã€‚',
      'åé‡Œæ´‹åœºé£æœˆé˜‘ï¼Œé­”éƒ½å¤œè‰²é†‰äººçœ ã€‚'
    ],
    // å¹¿ä¸œ
    'å¹¿ä¸œ': [
      'ç¾ŠåŸå…«æ™¯ä»ŠçŠ¹åœ¨ï¼Œç æ±Ÿæ½®æ¶Œå‘å—æµã€‚',
      'å²­å—å¤šé›¨é•¿é’æ ‘ï¼Œå¹¿åºœäººå®¶å°šå¤é£ã€‚',
      'çº¢æ£‰èŠ±å¼€æ˜¥è‰²æš–ï¼Œç æ±Ÿæ°´ç¢§æ˜ å—å¤©ã€‚'
    ],
    // æµ™æ±Ÿ
    'æµ™æ±Ÿ': [
      'ä¸œé£æ¸ç»¿è¥¿æ¹–æŸ³ï¼Œé›å·²è¿˜äººæœªå—å½’ã€‚',
      'é’±å¡˜æ±Ÿæ½®å£°å¦‚é›·ï¼Œè¥¿å­æ¹–ç•”æŸ³å¦‚çƒŸã€‚',
      'å±±å¤–é’å±±æ¥¼å¤–æ¥¼ï¼Œè¥¿æ¹–æ­Œèˆå‡ æ—¶ä¼‘ã€‚'
    ],
    // æ±Ÿè‹
    'æ±Ÿè‹': [
      'å§‘è‹åŸå¤–å¯’å±±å¯ºï¼Œå¤œåŠé’Ÿå£°åˆ°å®¢èˆ¹ã€‚',
      'çƒŸèŠ±ä¸‰æœˆä¸‹æ‰¬å·ï¼Œæ˜¥é£åé‡Œæ‰¬å·è·¯ã€‚',
      'æ˜¥æ¥æ±Ÿæ°´ç»¿å¦‚è“ï¼Œèƒ½ä¸å¿†æ±Ÿå—ã€‚'
    ],
    // å››å·
    'å››å·': [
      'èœ€é“éš¾ï¼Œéš¾äºä¸Šé’å¤©ï¼Œä¾§èº«è¥¿æœ›é•¿å’¨å—Ÿã€‚',
      'çª—å«è¥¿å²­åƒç§‹é›ªï¼Œé—¨æ³Šä¸œå´ä¸‡é‡Œèˆ¹ã€‚',
      'é”¦æ±Ÿæ˜¥è‰²æ¥å¤©åœ°ï¼Œç‰å’æµ®äº‘å˜å¤ä»Šã€‚'
    ],
    // æ¹–å—
    'æ¹–å—': [
      'æ¹˜æ±ŸåŒ—å»ï¼Œæ©˜å­æ´²å¤´ï¼Œçœ‹ä¸‡å±±çº¢éã€‚',
      'æ½‡æ¹˜å¤œé›¨æ¶¨ç§‹æ± ï¼ŒèŠ™è“‰èŠ±å¼€æ¥šå¤©ç¢§ã€‚',
      'æ´åº­å¤©ä¸‹æ°´ï¼Œå²³é˜³å¤©ä¸‹æ¥¼ã€‚'
    ],
    // æ¹–åŒ—
    'æ¹–åŒ—': [
      'é»„é¹¤ä¸€å»ä¸å¤è¿”ï¼Œç™½äº‘åƒè½½ç©ºæ‚ æ‚ ã€‚',
      'æ™´å·å†å†æ±‰é˜³æ ‘ï¼ŒèŠ³è‰è‹è‹é¹¦é¹‰æ´²ã€‚',
      'æ±Ÿæ±‰æœå®—æ±‡æ´åº­ï¼Œæ­¦å½“å±±ä¸Šæœ›é•¿æ±Ÿã€‚'
    ],
    // æ²³å—
    'æ²³å—': [
      'ä¸­å²³åµ©å±±é«˜ï¼Œé»„æ²³æ°´é•¿æµã€‚',
      'å•†éƒ½å¼€å°åƒå¹´æ¢¦ï¼Œå°‘æ—å¯ºé‡Œæ­¦é£æ‰¬ã€‚',
      'æ²³å—ä¹‹åœ°å±…ä¸­åŸï¼Œåå¤æ–‡æ˜èµ·æºå¤„ã€‚'
    ],
    // æ²³åŒ—
    'æ²³åŒ—': [
      'ç‡•èµµå¤šæ…·æ…¨æ‚²æ­Œä¹‹å£«ï¼Œé•¿åŸå†…å¤–å°½æ²§æ¡‘ã€‚',
      'ç™½æ´‹æ·€ä¸ŠèŠ¦èŠ±ç™½ï¼Œç‹¼ç‰™å±±ä¸‹æ¾æ¶›é¸£ã€‚',
      'æ‰¿å¾·é¿æš‘å±±åº„å¥½ï¼ŒåŒ—å›½é£å…‰èƒœæ±Ÿå—ã€‚'
    ],
    // å±±ä¸œ
    'å±±ä¸œ': [
      'æ³°å±±å¤©ä¸‹é›„ï¼Œé½é²å¤§åœ°å®½ã€‚',
      'å­”å­æ•…é‡Œå°šç¤¼ä»ªï¼Œæ›²é˜œåœ£åŸä¼ è–ªç«ã€‚',
      'ç™»ä¸œå±±è€Œå°é²ï¼Œç¯æµ·è§‚è€Œè‡ªå¾—ã€‚'
    ],
    // å±±è¥¿
    'å±±è¥¿': [
      'é»„æ²³å…¥æ™‹ç–†ï¼Œå¤ªè¡Œæ¨ªå³™ç«‹ã€‚',
      'å¹³é¥å¤åŸå¢™ï¼Œä¹”å®¶å¤§é™¢æ·±ã€‚',
      'å£¶å£ç€‘å¸ƒæƒŠå¤©åœ°ï¼Œäº‘å†ˆçŸ³çªŸè¿°å¤ä»Šã€‚'
    ],
    // é™•è¥¿
    'é™•è¥¿': [
      'ç§¦å·è‡ªå¤å¸ç‹å·ï¼Œå…µé©¬ä¿‘å‰å¿†ç§¦çš‡ã€‚',
      'è¥¿å®‰å¤åŸå¢™ï¼Œå¤§é›å¡”é«˜è€¸ï¼Œè¿°è¯´ç€é•¿å®‰çš„ç¹åã€‚',
      'åå±±å³°å³»é™©ï¼Œå»¶å®‰ç²¾ç¥ä¼ ã€‚'
    ],
    // ç¦å»º
    'ç¦å»º': [
      'é—½æ±Ÿå…¥æµ·æµï¼Œæ­¦å¤·å±±ä¸Šäº‘ã€‚',
      'åœŸæ¥¼åœ†å¦‚æœˆï¼Œå®¢å®¶æƒ…æ›´æ·±ã€‚',
      'é¼“æµªå±¿ä¸Šç´å£°è¿œï¼Œå¦é—¨æµ·ä¸Šæ˜æœˆå‡ã€‚'
    ],
    // äº‘å—
    'äº‘å—': [
      'è‹å±±æ´±æµ·ä¸¤ç›¸ä¾ï¼Œäº‘å—é£å…‰ç¾å¦‚ç”»ã€‚',
      'ä¸½æ±Ÿå¤åŸæ°´é•¿æµï¼Œé¦™æ ¼é‡Œæ‹‰æ˜¯å¤©å ‚ã€‚',
      'é«˜åŸæ˜ç æ»‡æ± æ°´ï¼ŒçŸ³æ—å¥‡è§‚å† å¤©ä¸‹ã€‚'
    ],
    // è´µå·
    'è´µå·': [
      'é»”å±±ç§€æ°´çš†å…¥ç”»ï¼Œè´µå·å¤šå½©æ°‘æ—æƒ…ã€‚',
      'é»„æœæ ‘ä¸‹æ°´å¦‚ç€‘ï¼Œæ¢µå‡€å±±ä¸­äº‘ä¼¼çº±ã€‚',
      'è´µå·å±±æ°´ç”²å¤©ä¸‹ï¼Œå¤šå½©è´µå·é£å…‰å¥½ã€‚'
    ],
    // å¹¿è¥¿
    'å¹¿è¥¿': [
      'æ¡‚æ—å±±æ°´ç”²å¤©ä¸‹ï¼Œé˜³æœ”é£å…‰ç¾å¦‚ç”»ã€‚',
      'æ¼“æ±Ÿæ°´ç¢§æ˜ é’å±±ï¼Œå£®ä¹¡æ­Œå£°ä¼ åƒé‡Œã€‚',
      'é¾™è„Šæ¢¯ç”°äº‘é›¾ç»•ï¼ŒåŒ—æµ·é“¶æ»©æµªèŠ±ç™½ã€‚'
    ],
    // æµ·å—
    'æµ·å—': [
      'æ¤°é£æµ·éŸµå—å›½æƒ…ï¼Œå¤©æ¶¯æµ·è§’å°½é£å…‰ã€‚',
      'ä¸‰äºšé˜³å…‰æ²™æ»©ç¾ï¼Œæµ·å£éª‘æ¥¼è¯æ²§æ¡‘ã€‚',
      'çƒ­å¸¦é£æƒ…æ¤°æ—ä¸‹ï¼Œç¢§æµ·è“å¤©å—æµ·è¾¹ã€‚'
    ],
    // æ±Ÿè¥¿
    'æ±Ÿè¥¿': [
      'åºå±±äº‘é›¾é”è‹ç©¹ï¼Œé„±é˜³æ¹–æ°´æ˜ æ™šéœã€‚',
      'æ»•ç‹é˜ä¸Šæœ›æ±Ÿæµï¼Œäº•å†ˆå±±ä¸Šçº¢æ——æ‰¬ã€‚',
      'æ±Ÿè¥¿ç‰©åå¤©å®åœ°ï¼Œè‹±é›„è¾ˆå‡ºèµ£é„±ä¹¡ã€‚'
    ],
    // å®‰å¾½
    'å®‰å¾½': [
      'é»„å±±äº‘æµ·æ¾æ¶›é¸£ï¼Œå¾½å·å¤éŸµå¢¨é¦™æµ“ã€‚',
      'æ–°å®‰æ±Ÿæ°´ç»•å¾½å·ï¼Œå®æ‘ç²‰å¢™é»›ç“¦é—´ã€‚',
      'ä¹åå±±ä¸Šä½›å…‰ç°ï¼Œçš–å—å±±æ°´å…¥ç”»æ¥ã€‚'
    ],
    // è¾½å®
    'è¾½å®': [
      'æ¸¤æµ·ä¹‹æ»¨è¾½æ²³é•¿ï¼Œæ²ˆé˜³æ•…å®«å¿†æ¸…æœã€‚',
      'å¤§è¿æ¸¯å£é€šå››æµ·ï¼Œéå±±é’¢é“é“¸è¾‰ç…Œã€‚',
      'è¾½æ²ˆå¤§åœ°æ˜¥å¸¸åœ¨ï¼Œä¸œåŒ—é£æƒ…äººéš¾å¿˜ã€‚'
    ],
    // å‰æ—
    'å‰æ—': [
      'é•¿ç™½å±±å·…å¤©æ± ç¢§ï¼Œæ¾èŠ±æ±Ÿæ°´å‘ä¸œæµã€‚',
      'é›¾å‡‡å†°æŒ‚é“¶ä¸–ç•Œï¼Œå‰æ—é£å…‰å†¬æ›´ç¾ã€‚',
      'åŒ—å›½é£å…‰åƒé‡Œé›ªï¼Œå‰æ—æ¾åŸç¨»èŠ±é¦™ã€‚'
    ],
    // é»‘é¾™æ±Ÿ
    'é»‘é¾™æ±Ÿ': [
      'é»‘åœŸåœ°ä¸Šç¨»èŠ±é¦™ï¼Œé¾™æ±Ÿä¸¤å²¸æ˜¥æ„æµ“ã€‚',
      'åŒ—å›½å†°é›ªé“¸å¥‡è§‚ï¼Œå“ˆå°”æ»¨åŸå¦‚ç«¥è¯ã€‚',
      'äº”å¤§è¿æ± ç«å±±å¥‡ï¼Œé•œæ³Šæ¹–ç€‘å¸ƒå£®è§‚ã€‚'
    ],
    // å†…è’™å¤
    'å†…è’™å¤': [
      'è‰åŸè¾½é˜”ä»»é©¬é©°ï¼Œè’™å¤åŒ…é‡Œè¯æ·±æƒ…ã€‚',
      'å‘¼ä¼¦è´å°”è‰åŸç¾ï¼Œé„‚å°”å¤šæ–¯æ²™æ¼ å¥‡ã€‚',
      'æ••å‹’æ­Œå£°éšé£è¿œï¼Œè“å¤©ç™½äº‘æ˜ è‰åŸã€‚'
    ],
    // å®å¤
    'å®å¤': [
      'è´ºå…°å±±ä¸‹æœå›­æˆï¼Œå…­ç›˜å±±ä¸Šæœé¹ƒçº¢ã€‚',
      'é»„æ²³å‡ å­—ç»•é“¶å·ï¼Œå¡ä¸Šæ±Ÿå—é£å…‰å¥½ã€‚',
      'è¥¿å¤å¤éƒ½è¿°æ²§æ¡‘ï¼Œå®å¤å›ä¹¡å±•æ–°å§¿ã€‚'
    ],
    // æ–°ç–†
    'æ–°ç–†': [
      'å¤©å±±å—åŒ—å¥½ç‰§åœºï¼Œå¸•ç±³å°”é«˜åŸäº‘é›¾ç»•ã€‚',
      'è‘¡è„ç¾é…’å¤œå…‰æ¯ï¼Œæ–°ç–†æ­ŒèˆåŠ¨äººå¿ƒã€‚',
      'å¡”é‡Œæœ¨æ²³æ°´å‘ä¸œæµï¼Œå¤©å±±é›ªæ¾å‚²è‹ç©¹ã€‚'
    ],
    // è¥¿è—
    'è¥¿è—': [
      'é›ªåŸŸé«˜åŸç¥åœ£åœ°ï¼Œå¸ƒè¾¾æ‹‰å®«äº‘é›¾ä¸­ã€‚',
      'çº³æœ¨é”™ç•”å¤©å¦‚é•œï¼Œç ç©†æœ—ç›å·…å¦‚ç¥ã€‚',
      'é’è—é«˜åŸé£å¹è¿‡ï¼Œé›…é²è—å¸ƒæ±Ÿæ°´é•¿ã€‚'
    ],
    // é’æµ·
    'é’æµ·': [
      'é’æµ·æ¹–ç•”è‰é’é’ï¼Œç¥è¿å±±ä¸‹ç‰¦ç‰›è¡Œã€‚',
      'ä¸‰æ±Ÿæºå¤´æ°´é•¿æµï¼Œæ˜†ä»‘å±±è„‰é›ªçš‘çš‘ã€‚',
      'å¡”å°”å¯ºé‡Œä½›å…‰ç°ï¼Œé’æµ·é«˜åŸäº‘é›¾ç»•ã€‚'
    ],
    // ç”˜è‚ƒ
    'ç”˜è‚ƒ': [
      'æ²³è¥¿èµ°å»Šé€šè¥¿åŸŸï¼Œæ•¦ç…Œè«é«˜çªŸå‰å¤ä»Šã€‚',
      'é»„æ²³ç©¿å…°å·ï¼Œå˜‰å³ªå…³å¤–å¤§æ¼ é£ã€‚',
      'ä¸ç»¸å¤é“é©¼é“ƒå“ï¼Œç”˜è‚ƒé£å…‰å£®å¦‚ç”»ã€‚'
    ],
    // å°æ¹¾
    'å°æ¹¾': [
      'å®å²›å°æ¹¾ç¢§æµ·ç¯ï¼Œé˜¿é‡Œå±±ä¸Šäº‘é›¾ç»•ã€‚',
      'æ—¥æœˆæ½­æ°´æ˜ é’å±±ï¼Œå°åŒ—åŸä¸­æ•…å®«ç§€ã€‚',
      'é«˜å±±æ—æ­Œå£°æ‚ æ‰¬ï¼Œå°æ¹¾é£æƒ…é†‰äººå¿ƒã€‚'
    ],
    // é¦™æ¸¯
    'é¦™æ¸¯': [
      'ç»´å¤šåˆ©äºšæ¸¯å¤œè‰²ç¾ï¼Œç‹®å­å±±ä¸‹è¯æ²§æ¡‘ã€‚',
      'ä¸œæ–¹ä¹‹ç è€€ä¸–ç•Œï¼Œé¦™æ±Ÿä¸¤å²¸ç¯å¦‚æ˜¼ã€‚',
      'é¦™æ¸¯æ•…äº‹å‡ å¤šæ„ï¼Œä¸œæ–¹æ˜ç å±•æ–°å§¿ã€‚'
    ],
    // æ¾³é—¨
    'æ¾³é—¨': [
      'æ¾³é—¨å¤œè‰²ç’€ç’¨æ˜ï¼Œè‘¡å¼å»ºç­‘è¯‰æ²§æ¡‘ã€‚',
      'å¦ˆç¥–åº™å‰é¦™ç«æ—ºï¼Œå¤§ä¸‰å·´ç‰ŒåŠç«‹å¦‚æ•…ã€‚',
      'è²èŠ±ç»½æ”¾å—æµ·è¾¹ï¼Œä¸œè¥¿æ–‡åŒ–åœ¨æ¾³é—¨ã€‚'
    ]
  };
  
  // é»˜è®¤è¯—å¥
  const defaultPoems = [
    'æµ·å†…å­˜çŸ¥å·±ï¼Œå¤©æ¶¯è‹¥æ¯”é‚»ã€‚',
    'è«æ„å‰è·¯æ— çŸ¥å·±ï¼Œå¤©ä¸‹è°äººä¸è¯†å›ã€‚',
    'ä¸œé£æ¸ç»¿è¥¿æ¹–æŸ³ï¼Œé›å·²è¿˜äººæœªå—å½’ã€‚',
    'æµ·ä¸Šç”Ÿæ˜æœˆï¼Œå¤©æ¶¯å…±æ­¤æ—¶ã€‚',
    'å¤©å—åœ°åŒ—ï¼ŒåŒé£å®¢ï¼Œè€ç¿…å‡ å›å¯’æš‘ã€‚'
  ];
  
  // æ ¹æ®çœä»½æŸ¥æ‰¾è¯—å¥
  let poems = [];
  if (province) {
    // ç§»é™¤"çœ"ã€"å¸‚"ã€"è‡ªæ²»åŒº"ç­‰åç¼€ä»¥ä¾¿åŒ¹é…
    const simplifiedProvince = province.replace(/çœ|å¸‚|è‡ªæ²»åŒº|ç‰¹åˆ«è¡Œæ”¿åŒº|ç»´å¾å°”|å›æ—|å£®æ—|è—æ—|è’™å¤æ—/g, '');
    poems = regionPoems[simplifiedProvince];
  }
  
  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çœä»½çš„è¯—å¥ï¼Œä½¿ç”¨é»˜è®¤è¯—å¥
  if (!poems || poems.length === 0) {
    poems = defaultPoems;
  }
  
  // éšæœºé€‰æ‹©ä¸€å¥è¯—
  const randomIndex = Math.floor(Math.random() * poems.length);
  return poems[randomIndex];
}

// æ›´æ–°å…¬å‘Šæ å†…å®¹
async function updateAnnouncement() {
  const announcementContent = document.querySelector('.announcement_content');
  if (!announcementContent) return;
  
  // è·å–è®¿å®¢ä¿¡æ¯å’ŒæœåŠ¡å™¨ä¿¡æ¯
  const visitorInfo = await getVisitorInfo();
  const serverIP = await getServerIP();
  const currentTime = getCurrentTime();
  const greeting = getGreeting();
  
  // æœåŠ¡å™¨ä½ç½®åæ ‡ï¼ˆæ­å·ï¼‰- å®é™…éƒ¨ç½²æ—¶åº”è¯¥æ›´æ–°ä¸ºçœŸå®æœåŠ¡å™¨ä½ç½®
  const serverLocation = {
    latitude: 30.2741,
    longitude: 120.1551
  };
  
  // è®¡ç®—è®¿å®¢ä¸æœåŠ¡å™¨ä¹‹é—´çš„è·ç¦»
  const distance = calculateDistance(
    visitorInfo.latitude, 
    visitorInfo.longitude, 
    serverLocation.latitude, 
    serverLocation.longitude
  );
  
  // æ ¹æ®è®¿å®¢åœ°åŸŸè·å–ç›¸åº”çš„è¯—å¥
  const poem = getPoemByRegion(visitorInfo.province, visitorInfo.city);
  
  // æ£€æµ‹å½“å‰ä¸»é¢˜æ˜¯å¦ä¸ºæ·±è‰²æ¨¡å¼
  const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
  
  // æ ¹æ®ä¸»é¢˜è®¾ç½®ä¸åŒçš„æ ·å¼
  const bgColor = isDarkMode ? '#1a1b27' : '#f0f8ff';
  const textColor = isDarkMode ? '#fff' : '#333';
  const accentColor = '#00c4b6';
  
  // æ›´æ–°å…¬å‘Šæ å†…å®¹ï¼Œæ ¹æ®ä¸»é¢˜ä½¿ç”¨ä¸åŒçš„æ ·å¼
  announcementContent.innerHTML = `
    <div style="text-align: center; background-color: ${bgColor}; color: ${textColor}; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px ${isDarkMode ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.1)'}; transition: all 0.3s;">
      <div style="margin-bottom: 10px;">
        <span style="font-size: 1.1em;">${isDarkMode ? 'ğŸ‰ æ¬¢è¿ä¿¡æ¯ ğŸ‰' : 'ğŸ“¢ å…¬å‘Šæ  ğŸ“¢'}</span>
      </div>
      <div style="margin-bottom: 5px; font-size: 0.9em;">
        æ¬¢è¿æ¥è‡ª 
        <span style="color: ${accentColor};">${visitorInfo.province} ${visitorInfo.city}</span> çš„å°ä¼™ä¼´ï¼Œ${greeting}ï¼æ‚¨ç°åœ¨è·ç¦»ç«™é•¿çº¦ 
        <span style="color: ${accentColor};">${distance}</span> å…¬é‡Œï¼Œå½“å‰çš„IPåœ°å€ä¸ºï¼š
        <span style="color: ${accentColor};">${visitorInfo.ip}</span>ï¼Œ ${poem}
        å¸Œæœ›æœ¬ç«™èƒ½ä¸ºä½ å¸¦æ¥æ„‰å¿«çš„ä½“éªŒï¼
      </div>
    </div>
  `;
}

// ç›‘å¬ä¸»é¢˜åˆ‡æ¢äº‹ä»¶ï¼Œå½“ä¸»é¢˜å˜åŒ–æ—¶æ›´æ–°å…¬å‘Šæ 
function setupThemeChangeListener() {
  // åˆ›å»ºä¸€ä¸ªMutationObserveræ¥ç›‘å¬data-themeå±æ€§çš„å˜åŒ–
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
        // å½“data-themeå±æ€§å˜åŒ–æ—¶ï¼Œæ›´æ–°å…¬å‘Šæ 
        updateAnnouncement();
      }
    });
  });
  
  // å¼€å§‹è§‚å¯Ÿdocument.documentElementçš„data-themeå±æ€§å˜åŒ–
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
window.addEventListener('DOMContentLoaded', () => {
  // åˆå§‹æ›´æ–°
  updateAnnouncement();
  
  // è®¾ç½®ä¸»é¢˜åˆ‡æ¢ç›‘å¬
  setupThemeChangeListener();
  
  // æ¯éš”ä¸€å°æ—¶æ›´æ–°ä¸€æ¬¡ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´æ›´æ–°é¢‘ç‡ï¼‰
  setInterval(updateAnnouncement, 3600000);
});